<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>the MOtivation club</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase compat SDKs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-auth-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-firestore-compat.min.js"></script>
  <style>
    * {
      font-family: 'Montserrat', sans-serif;
    }

    body {
      background: #12123E;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDq1fJ_4QCXw-3XtTnCmR0hRbUuSSWx2Nc",
      authDomain: "the-motivation-club.firebaseapp.com",
      projectId: "the-motivation-club",
      storageBucket: "the-motivation-club.firebasestorage.app",
      messagingSenderId: "298033717951",
      appId: "1:298033717951:web:df2ac43fe0477bf3ae1c0a"
    };

    const REWARDS = {
      common: {
        rarity: 'Common',
        chance: 0.65,
        color: 'bg-gray-100',
        borderColor: 'border-gray-300',
        textColor: 'text-gray-900',
        badgeColor: 'bg-gray-200 text-gray-700',
        items: [
          { emoji: '☕', title: 'Coffee', description: 'Under $10' },
          { emoji: '🥤', title: 'Wawa Drink', description: 'Pre-work only' },
          { emoji: '🥤', title: 'Fast Food Drink', description: 'Not McDonald\'s' },
          { emoji: '🧋', title: 'Boba', description: 'Any time!' },
          { emoji: '🍬', title: 'Candy for Bobo', description: 'Under $5' },
          { emoji: '🍿', title: 'Pick a Snack', description: 'Under $10' },
          { emoji: '💋', title: '10 Kisses', description: 'Redeemable anytime' },
          { emoji: '🤗', title: '10 Hugs', description: 'Redeemable anytime' },
          { emoji: '⚡', title: 'Energy Drink of Choice', description: 'Any brand!' },
          { emoji: '🍦', title: 'Ice Cream for Bobo', description: 'Treat yourself!' }
        ]
      },
      uncommon: {
        rarity: 'Uncommon',
        chance: 0.25,
        color: 'bg-emerald-50',
        borderColor: 'border-emerald-300',
        textColor: 'text-emerald-900',
        badgeColor: 'bg-emerald-100 text-emerald-700',
        items: [
          { emoji: '🍰', title: 'Dessert on Me', description: 'Must be claimed before meal' },
          { emoji: '👕', title: 'A Shirt of Your Choosing', description: 'Within reason' },
          { emoji: '🎮', title: 'Unbothered Gaming Day', description: 'No interruptions!' },
          { emoji: '🚗', title: 'Drive-Thru Surprise', description: 'Order anything' },
          { emoji: '🍱', title: 'Takeout of His Choice', description: 'Mid-tier restaurant, ~$30' }
        ]
      },
      rare: {
        rarity: 'Rare',
        chance: 0.08,
        color: 'bg-cyan-50',
        borderColor: 'border-cyan-400',
        textColor: 'text-cyan-900',
        badgeColor: 'bg-cyan-100 text-cyan-700',
        items: [
          { emoji: '🧁', title: 'Instagram/TikTok Baked Good', description: 'Within reason, I\'ll make it!' },
          { emoji: '🍽️', title: 'Meal is on Me', description: 'Bill under $50' },
          { emoji: '🎉', title: 'Activity Night - Your Choice', description: 'No complaints allowed' },
          { emoji: '🎯', title: 'CS:GO Session', description: 'We\'re gonna play bestie' }
        ]
      },
      legendary: {
        rarity: 'Legendary',
        chance: 0.02,
        color: 'bg-gradient-to-br from-cyan-100 to-teal-100',
        borderColor: 'border-teal-400',
        textColor: 'text-teal-900',
        badgeColor: 'bg-gradient-to-r from-cyan-500 to-teal-500 text-white',
        items: [
          { emoji: '🛍️', title: 'Shopping Spree', description: 'Up to $100' },
          { emoji: '🌟', title: 'Wild Card', description: 'Ask for anything!' },
          { emoji: '🎮', title: 'I Will Actually Play Persona', description: 'The ultimate sacrifice' }
        ]
      }
    };

    function GymLootBox() {
      const [user, setUser] = useState(null);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [isSignUp, setIsSignUp] = useState(false);
      const [authError, setAuthError] = useState('');
      const [gymLog, setGymLog] = useState({ didGym: '', workout: '', photo: null, photoURL: '' });

      const [inventory, setInventory] = useState([]); // rewards
      const [logs, setLogs] = useState([]);           // daily accomplishments

      const [showReward, setShowReward] = useState(false);
      const [currentReward, setCurrentReward] = useState(null);
      const [isOpening, setIsOpening] = useState(false);
      const [stats, setStats] = useState({ total: 0, thisWeek: 0 });
      const [lastLogDate, setLastLogDate] = useState('');
      const [loading, setLoading] = useState(true);
      const [auth, setAuth] = useState(null);
      const [db, setDb] = useState(null);

      // calendar state
      const [calMonth, setCalMonth] = useState(() => {
        const d = new Date();
        return new Date(d.getFullYear(), d.getMonth(), 1);
      });
      const [selectedDayISO, setSelectedDayISO] = useState(null);

      // unsub refs
      const invUnsubRef = useRef(null);
      const logsUnsubRef = useRef(null);
      const userDocUnsubRef = useRef(null);

      useEffect(() => {
        if (!window.firebase) {
          alert('Firebase scripts failed to load');
          setLoading(false);
          return;
        }
        try {
          if (firebase.apps.length === 0) firebase.initializeApp(FIREBASE_CONFIG);
          const firebaseAuth = firebase.auth();
          const firebaseDb = firebase.firestore();
          setAuth(firebaseAuth);
          setDb(firebaseDb);

          firebaseAuth.onAuthStateChanged(async (u) => {
            // clean listeners
            [invUnsubRef, logsUnsubRef, userDocUnsubRef].forEach(ref => { if (ref.current) { ref.current(); ref.current = null; } });

            setUser(u);
            if (u) {
              // user doc listener
              userDocUnsubRef.current = firebaseDb.collection('users').doc(u.uid)
                .onSnapshot((snap) => {
                  const data = snap.data() || {};
                  setStats(data.stats || { total: 0, thisWeek: 0 });
                  setLastLogDate(data.lastLogDate || '');
                });

              // rewards (inventory) listener
              invUnsubRef.current = firebaseDb.collection('users').doc(u.uid)
                .collection('inventory').orderBy('createdAt', 'desc')
                .onSnapshot((qs) => {
                  const items = qs.docs.map(d => ({ id: d.id, ...d.data() }));
                  setInventory(items);
                });

              // logs listener (NEW)
              logsUnsubRef.current = firebaseDb.collection('users').doc(u.uid)
                .collection('logs').orderBy('dayISO', 'desc')
                .onSnapshot((qs) => {
                  const items = qs.docs.map(d => ({ id: d.id, ...d.data() }));
                  setLogs(items);
                });

            } else {
              setInventory([]);
              setLogs([]);
              setStats({ total: 0, thisWeek: 0 });
              setLastLogDate('');
            }
            setLoading(false);
          });
        } catch (error) {
          console.error('Firebase initialization error:', error);
          alert('Firebase Error: ' + error.message);
          setLoading(false);
        }
        return () => {
          [invUnsubRef, logsUnsubRef, userDocUnsubRef].forEach(ref => ref.current && ref.current());
        };
      }, []);

      // --- Helpers (LOCAL dates only) ---
      const toast = (msg) => alert(msg);
      const pad2 = (n) => (n < 10 ? `0${n}` : `${n}`);
      const getTodayString = () => {
        const d = new Date();
        return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
      };
      const ymd = (y, m0, d) => `${y}-${pad2(m0 + 1)}-${pad2(d)}`;
      const localDateFromISO = (iso) => {
        const [y, m, d] = iso.split('-').map(Number);
        return new Date(y, m - 1, d);
      };

      const hasLoggedToday = () => lastLogDate === getTodayString();
      const daysInMonth = (y, m0) => new Date(y, m0 + 1, 0).getDate();

      function buildMonthMatrix(date) {
        const y = date.getFullYear();
        const m0 = date.getMonth();
        const firstDow = new Date(y, m0, 1).getDay();
        const dim = daysInMonth(y, m0);

        const prevMonth0 = (m0 + 11) % 12;
        const prevYear = m0 === 0 ? y - 1 : y;
        const prevDim = daysInMonth(prevYear, prevMonth0);

        const cells = [];
        for (let i = 0; i < 42; i++) {
          const cell = { inMonth: true, year: y, month0: m0, day: 1, iso: '' };

          if (i < firstDow) {
            const d = prevDim - (firstDow - 1 - i);
            cell.inMonth = false; cell.year = prevYear; cell.month0 = prevMonth0; cell.day = d;
          } else if (i >= firstDow + dim) {
            const nextMonth0 = (m0 + 1) % 12;
            const nextYear = m0 === 11 ? y + 1 : y;
            const d = i - (firstDow + dim) + 1;
            cell.inMonth = false; cell.year = nextYear; cell.month0 = nextMonth0; cell.day = d;
          } else {
            cell.day = i - firstDow + 1;
          }
          cell.iso = ymd(cell.year, cell.month0, cell.day);
          cells.push(cell);
        }
        return Array.from({ length: 6 }, (_, w) => cells.slice(w * 7, w * 7 + 7));
      }

      const saveUserDocMerge = async (obj) => {
        if (!user || !db) return;
        await db.collection('users').doc(user.uid).set(obj, { merge: true });
      };

      const handleAuth = async () => {
        setAuthError('');
        if (!email || !password) {
          setAuthError('Please enter email and password');
          return;
        }
        try {
          if (isSignUp) {
            await auth.createUserWithEmailAndPassword(email, password);
          } else {
            await auth.signInWithEmailAndPassword(email, password);
          }
          setEmail(''); setPassword('');
        } catch (error) {
          console.error(error);
          setAuthError(
            error.code === 'auth/email-already-in-use' ? 'Email already in use' :
              error.code === 'auth/weak-password' ? 'Password too weak' :
                error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' ? 'Invalid credentials' :
                  'Auth failed'
          );
        }
      };

      const getRarity = () => {
        const roll = Math.random();
        let cumulative = 0;
        for (const key in REWARDS) {
          cumulative += REWARDS[key].chance;
          if (roll <= cumulative) return key;
        }
        return 'common';
      };

      const openLootBox = async () => {
        if (!user) return toast('Please sign in first.');
        if (!gymLog.didGym || !gymLog.workout.trim()) return toast('Please fill out the gym log!');
        if (!gymLog.photoURL) return toast('Please upload a gym selfie to prove it!');
        if (hasLoggedToday()) return toast('Already logged today! Come back tomorrow.');

        setIsOpening(true);
        setTimeout(async () => {
          const todayISO = getTodayString();
          try {
            // 1) ALWAYS save the workout log (separate collection)
            await db.collection('users').doc(user.uid)
              .collection('logs').doc(todayISO) // one log per day
              .set({
                id: todayISO,
                dayISO: todayISO,
                datePretty: new Date().toLocaleDateString(),
                workout: gymLog.workout,
                photoURL: gymLog.photoURL,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              });

            // 2) THEN roll and save a reward (independent)
            const rarityKey = getRarity();
            const rewardData = REWARDS[rarityKey];
            const randomItem = rewardData.items[Math.floor(Math.random() * rewardData.items.length)];
            const reward = {
              emoji: randomItem.emoji,
              title: randomItem.title,
              description: randomItem.description,
              rarity: rewardData.rarity,
              color: rewardData.color,
              borderColor: rewardData.borderColor,
              textColor: rewardData.textColor,
              badgeColor: rewardData.badgeColor,
              date: new Date().toLocaleDateString(),
              dayISO: todayISO,
              redeemed: false,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            };
            await db.collection('users').doc(user.uid)
              .collection('inventory').add(reward);

            // 3) user stats / lastLogDate
            await saveUserDocMerge({
              stats: { total: (stats.total || 0) + 1, thisWeek: (stats.thisWeek || 0) + 1 },
              lastLogDate: todayISO,
            });

            // reward modal for fun
            setCurrentReward({ ...reward });
            setShowReward(true);
            setGymLog({ didGym: '', workout: '', photo: null, photoURL: '' });
          } catch (e) {
            console.error(e);
            toast('Could not save. Check Firestore rules & authorized domains.');
          } finally {
            setIsOpening(false);
          }
        }, 900);
      };

      const redeemReward = async (id) => {
        if (!user || !db) return;
        try {
          await db.collection('users').doc(user.uid)
            .collection('inventory').doc(id)
            .update({ redeemed: true, redeemedAt: firebase.firestore.FieldValue.serverTimestamp() });
        } catch (e) { console.error(e); toast('Could not redeem.'); }
      };

      const deleteReward = async (id) => {
        if (!user || !db) return;
        try {
          await db.collection('users').doc(user.uid)
            .collection('inventory').doc(id)
            .delete();
        } catch (e) { console.error(e); toast('Could not delete.'); }
      };

      // group LOGS by dayISO (calendar + day modal use logs only)
      const byDay = React.useMemo(() => {
        const map = {};
        for (const r of logs) {
          const key = r.dayISO || '';
          if (!key) continue;
          if (!map[key]) map[key] = [];
          map[key].push(r);
        }
        return map;
      }, [logs]);

      if (loading) {
        return (
          <div style={{ background: '#12123E' }} className="min-h-screen flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-teal-400 mx-auto mb-4"></div>
              <p className="text-white text-xl font-semibold">Loading...</p>
            </div>
          </div>
        );
      }

      if (!user) {
        return (
          <div style={{ background: '#12123E' }} className="min-h-screen flex items-center justify-center p-4">
            <div className="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl">
              <div className="text-center mb-8">
                <img src="logo.png" alt="MOtivation club" className="h-32 w-auto mx-auto mb-6" />
                <p className="text-gray-600 font-medium">Sign in to start earning rewards</p>
              </div>

              <div className="space-y-4">
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && handleAuth()}
                  placeholder="Email"
                  className="w-full py-3 px-4 rounded-xl bg-gray-50 text-gray-900 placeholder-gray-400 border-2 border-gray-200 focus:outline-none focus:border-teal-400 font-medium"
                />
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && handleAuth()}
                  placeholder="Password"
                  className="w-full py-3 px-4 rounded-xl bg-gray-50 text-gray-900 placeholder-gray-400 border-2 border-gray-200 focus:outline-none focus:border-teal-400 font-medium"
                />

                {authError && (
                  <div className="bg-red-50 border-2 border-red-200 rounded-xl p-3 text-red-700 text-sm font-medium">
                    {authError}
                  </div>
                )}

                <button onClick={handleAuth} className="w-full bg-gradient-to-r from-teal-400 to-cyan-500 text-white font-bold py-3 px-6 rounded-xl hover:shadow-lg transition-all">
                  {isSignUp ? 'Sign Up' : 'Log In'}
                </button>

                <button onClick={() => { setIsSignUp(!isSignUp); setAuthError(''); }} className="w-full text-gray-600 hover:text-gray-900 transition-colors text-sm font-medium">
                  {isSignUp ? 'Already have an account? Log in' : "Don't have an account? Sign up"}
                </button>
              </div>
            </div>
          </div>
        );
      }

      const activeRewards = inventory.filter(r => !r.redeemed);
      const redeemedRewards = inventory.filter(r => r.redeemed);

      return (
        <div style={{ background: '#12123E' }} className="min-h-screen p-4">
          <div className="max-w-4xl mx-auto">
            <div className="text-center mb-8 pt-8">
              <div className="mb-6">
                <img src="logo.png" alt="MOtivation club" className="w-full max-w-2xl mx-auto h-auto" />
              </div>
              <p className="text-gray-400 text-lg mb-4 font-medium">Work out, earn epic rewards</p>
              <button onClick={() => auth.signOut()} className="text-gray-400 hover:text-white transition-colors text-sm font-medium">
                {user.email} • Sign Out
              </button>
            </div>

            <div className="grid grid-cols-2 gap-4 mb-8">
              <div className="bg-white rounded-2xl p-6 text-center shadow-xl">
                <div className="text-5xl font-extrabold text-gray-900 mb-1">{stats.total}</div>
                <div className="text-gray-600 font-semibold">Total Workouts</div>
              </div>
              <div className="bg-white rounded-2xl p-6 text-center shadow-xl">
                <div className="text-5xl font-extrabold text-teal-500 mb-1">{activeRewards.length}</div>
                <div className="text-gray-600 font-semibold">Rewards Available</div>
              </div>
            </div>

            <div className="bg-white rounded-3xl p-8 mb-8 shadow-xl">
              <h2 className="text-2xl font-extrabold text-gray-900 mb-6">Log Your Workout</h2>

              {hasLoggedToday() ? (
                <div className="bg-teal-50 border-2 border-teal-400 rounded-2xl p-8 text-center">
                  <div className="text-6xl mb-4">✅</div>
                  <h3 className="text-2xl font-extrabold text-gray-900 mb-2">Already Logged Today!</h3>
                  <p className="text-gray-600 text-lg font-medium">Come back tomorrow for another loot box</p>
                </div>
              ) : (
                <div className="space-y-6">
                  <div>
                    <label className="block text-gray-700 mb-3 text-lg font-semibold">Did you gym today?</label>
                    <div className="flex gap-4">
                      <button onClick={() => setGymLog({ ...gymLog, didGym: 'yes' })} className={`flex-1 py-4 px-6 rounded-xl font-bold text-lg transition-all ${gymLog.didGym === 'yes' ? 'bg-teal-500 text-white shadow-lg scale-105' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                        Yes
                      </button>
                      <button onClick={() => setGymLog({ ...gymLog, didGym: 'no' })} className={`flex-1 py-4 px-6 rounded-xl font-bold text-lg transition-all ${gymLog.didGym === 'no' ? 'bg-red-500 text-white shadow-lg scale-105' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                        No
                      </button>
                    </div>
                  </div>

                  {gymLog.didGym === 'yes' && (
                    <>
                      <div>
                        <label className="block text-gray-700 mb-3 text-lg font-semibold">What workout?</label>
                        <input
                          type="text"
                          value={gymLog.workout}
                          onChange={(e) => setGymLog({ ...gymLog, workout: e.target.value })}
                          placeholder="e.g., Chest & Triceps, Leg Day, Cardio..."
                          className="w-full py-4 px-6 rounded-xl bg-gray-50 text-gray-900 placeholder-gray-400 border-2 border-gray-200 focus:outline-none focus:border-teal-400 text-lg font-medium"
                        />
                      </div>

                      <div>
                        <label className="block text-gray-700 mb-3 text-lg font-semibold">Upload Gym Selfie 📸</label>
                        {gymLog.photoURL ? (
                          <div className="relative border-2 border-teal-400 rounded-xl overflow-hidden">
                            <img src={gymLog.photoURL} alt="Gym selfie" className="w-full h-64 object-cover" />
                            <button
                              onClick={() => setGymLog({ ...gymLog, photo: null, photoURL: '' })}
                              className="absolute top-3 right-3 bg-red-500 text-white rounded-full w-10 h-10 flex items-center justify-center font-bold hover:bg-red-600 text-xl shadow-lg"
                            >
                              ×
                            </button>
                          </div>
                        ) : (
                          <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-teal-400 hover:bg-gray-50 transition-all cursor-pointer">
                            <input
                              type="file"
                              accept="image/*"
                              id="photoUpload"
                              className="hidden"
                              onChange={(e) => {
                                const file = e.target.files[0];
                                if (file) {
                                  const reader = new FileReader();
                                  reader.onloadend = () => {
                                    setGymLog({ ...gymLog, photo: file, photoURL: reader.result });
                                  };
                                  reader.readAsDataURL(file);
                                }
                              }}
                            />
                            <label htmlFor="photoUpload" className="cursor-pointer block">
                              <div className="text-6xl mb-3">📸</div>
                              <div className="bg-gradient-to-r from-teal-400 to-cyan-500 text-white font-bold py-3 px-6 rounded-xl inline-block mb-3 hover:shadow-lg transition-all">
                                Choose Photo
                              </div>
                              <p className="text-gray-500 text-sm">Take a gym selfie to prove your workout</p>
                            </label>
                          </div>
                        )}
                      </div>

                      <button onClick={openLootBox} disabled={isOpening} className="w-full bg-gradient-to-r from-teal-400 to-cyan-500 text-white font-extrabold py-5 px-6 rounded-xl text-xl shadow-xl hover:shadow-2xl transition-all hover:scale-105 disabled:opacity-50">
                        {isOpening ? 'Opening Loot Box...' : 'Open Loot Box'}
                      </button>
                    </>
                  )}
                </div>
              )}
            </div>

            {/* CALENDAR / ACTIVITY LOG (reads from logs) */}
            <div className="bg-white rounded-3xl p-6 mb-8 shadow-xl">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-2xl font-extrabold text-gray-900">Activity Calendar</h2>
                <div className="flex items-center gap-2">
                  <button
                    className="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold"
                    onClick={() => setCalMonth(new Date(calMonth.getFullYear(), calMonth.getMonth() - 1, 1))}
                  >◀</button>
                  <div className="text-gray-800 font-bold">
                    {calMonth.toLocaleString(undefined, { month: 'long', year: 'numeric' })}
                  </div>
                  <button
                    className="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold"
                    onClick={() => setCalMonth(new Date(calMonth.getFullYear(), calMonth.getMonth() + 1, 1))}
                  >▶</button>
                </div>
              </div>

              <div className="grid grid-cols-7 gap-1 text-xs font-bold text-gray-500 mb-1">
                {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
                  <div key={d} className="text-center py-2">{d}</div>
                ))}
              </div>

              <div className="grid grid-cols-7 gap-1">
                {buildMonthMatrix(calMonth).flat().map((cell, idx) => {
                  const hasLogs = byDay[cell.iso] && byDay[cell.iso].length > 0;
                  const isToday = cell.iso === getTodayString();
                  return (
                    <button
                      key={idx}
                      onClick={() => setSelectedDayISO(cell.iso)}
                      className={[
                        "h-20 rounded-xl border text-left p-2 transition",
                        cell.inMonth ? "bg-white border-gray-200" : "bg-gray-50 border-gray-200 opacity-70",
                        "hover:border-teal-400 hover:shadow-sm"
                      ].join(" ")}
                    >
                      <div className="flex items-center justify-between">
                        <span className={`text-sm font-bold ${cell.inMonth ? "text-gray-800" : "text-gray-400"}`}>{cell.day}</span>
                        {isToday && <span className="text-[10px] px-2 py-0.5 rounded-full bg-teal-100 text-teal-700 font-bold">Today</span>}
                      </div>
                      {hasLogs && (
                        <div className="mt-3">
                          <div className="text-xs font-semibold text-teal-700">
                            {byDay[cell.iso].length} log{byDay[cell.iso].length > 1 ? 's' : ''}
                          </div>
                          <div className="flex mt-1 gap-1">
                            {byDay[cell.iso].slice(0, 3).map((r, i) => (
                              <span key={i} title="workout logged" className="w-2 h-2 rounded-full bg-teal-400 inline-block"></span>
                            ))}
                          </div>
                        </div>
                      )}
                    </button>
                  );
                })}
              </div>
            </div>

            {showReward && currentReward && (
              <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl">
                  <div className="text-center">
                    <div className="text-6xl mb-4">✨</div>
                    <div className={`inline-block px-6 py-2 rounded-full ${currentReward.badgeColor} font-bold text-lg mb-4`}>
                      {currentReward.rarity}
                    </div>
                    <div className="text-7xl mb-4">{currentReward.emoji}</div>
                    <h3 className="text-3xl font-extrabold text-gray-900 mb-3">{currentReward.title}</h3>
                    <p className="text-gray-600 text-sm mb-6 font-medium italic">{currentReward.description}</p>
                    <button onClick={() => setShowReward(false)} className="bg-gradient-to-r from-teal-400 to-cyan-500 text-white font-bold py-3 px-8 rounded-xl hover:shadow-lg transition-all text-lg">
                      Awesome!
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* DAY DETAIL MODAL — accomplishments only (reads from logs) */}
            {selectedDayISO && (
              <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-3xl p-6 w-full max-w-3xl shadow-2xl">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-xl font-extrabold text-gray-900">
                      {localDateFromISO(selectedDayISO).toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                    </h3>
                    <button onClick={() => setSelectedDayISO(null)} className="text-gray-500 hover:text-gray-900 font-bold text-lg">×</button>
                  </div>

                  {(!byDay[selectedDayISO] || byDay[selectedDayISO].length === 0) ? (
                    <div className="text-gray-500">No logs for this day.</div>
                  ) : (
                    <div className="space-y-4 max-h-[70vh] overflow-auto pr-1">
                      {byDay[selectedDayISO].map((r) => (
                        <div key={r.id} className="border border-gray-200 rounded-2xl p-4 flex gap-4 items-start">
                          {r.photoURL && (
                            <img src={r.photoURL} alt="Workout proof" className="w-28 h-28 sm:w-32 sm:h-32 object-cover rounded-xl flex-shrink-0" />
                          )}
                          <div className="flex-1">
                            <div className="text-base text-gray-900 font-bold mb-1">Workout</div>
                            <div className="text-[15px] text-gray-700">{r.workout || '—'}</div>
                            {r.createdAt?.seconds && (
                              <div className="text-xs text-gray-500 mt-2">
                                Logged at {new Date(r.createdAt.seconds * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* REWARDS */}
            <div className="bg-white rounded-3xl p-8 mb-8 shadow-xl">
              <h2 className="text-2xl font-extrabold text-gray-900 mb-6">Available Rewards ({activeRewards.length})</h2>
              {activeRewards.length === 0 ? (
                <p className="text-gray-500 text-center py-8 font-medium">No rewards yet. Hit the gym!</p>
              ) : (
                <div className="grid gap-4">
                  {activeRewards.map((reward) => (
                    <div key={reward.id} className={`${reward.color} rounded-2xl p-6 border-2 ${reward.borderColor}`}>
                      <div className="flex items-start justify-between gap-4">
                        <div className="flex-1">
                          <div className="flex items-center gap-3 mb-2">
                            <span className="text-3xl">{reward.emoji}</span>
                            <span className={`text-xl font-bold ${reward.textColor}`}>{reward.title}</span>
                          </div>
                          <p className="text-gray-600 text-sm mb-2 italic">{reward.description}</p>
                          <div className="text-gray-500 text-xs font-medium">{reward.date}</div>
                        </div>
                        <div className="flex gap-2">
                          {!reward.redeemed && (
                            <button onClick={() => redeemReward(reward.id)} className="bg-gray-900 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-800 transition-all flex-shrink-0">
                              Redeem
                            </button>
                          )}
                          <button onClick={() => deleteReward(reward.id)} className="text-gray-600 hover:text-red-500 transition-colors text-sm px-3 py-2 font-medium">
                            Delete
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {redeemedRewards.length > 0 && (
              <div className="bg-white rounded-3xl p-8 shadow-xl">
                <h2 className="text-2xl font-extrabold text-gray-900 mb-6">Redeemed Rewards ({redeemedRewards.length})</h2>
                <div className="grid gap-3">
                  {redeemedRewards.map((reward) => (
                    <div key={reward.id} className="bg-gray-50 rounded-xl p-4 border-2 border-gray-200 flex items-center justify-between">
                      <div className="flex items-center gap-3 flex-1">
                        <span className="text-2xl opacity-50">{reward.emoji}</span>
                        <div>
                          <div className="text-gray-400 line-through font-medium">{reward.title}</div>
                          <div className="text-gray-400 text-xs">{reward.date}</div>
                        </div>
                      </div>
                      <button onClick={() => deleteReward(reward.id)} className="text-gray-400 hover:text-red-500 transition-colors text-sm px-3 py-1 font-medium">
                        Delete
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<GymLootBox />, document.getElementById('root'));
  </script>
</body>

</html>